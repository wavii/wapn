<!DOCTYPE html><html lang="en"><head><title>wapn/provider</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="wapn/provider"><meta name="groc-project-path" content="lib/wapn/provider.rb"><meta name="groc-github-url" content="https://github.com/wavii/wapn"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/wavii/wapn/blob/master/lib/wapn/provider.rb">lib/wapn/provider.rb</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="wapnprovider">WAPN::Provider</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nb">require</span> <span class="s2">&quot;wapn/connection&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;wapn/delivery_error&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;wapn/notification&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;wapn/payload&quot;</span>

<span class="k">module</span> <span class="nn">WAPN</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A <code>Provider</code> is an abstraction around the APNs concept of providers.</p></div></div><div class="code"><div class="wrapper">  <span class="k">class</span> <span class="nc">Provider</span>

    <span class="no">STANDARD_ENVIRONMENTS</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">production</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">gateway_host</span><span class="p">:</span>  <span class="s2">&quot;gateway.push.apple.com&quot;</span><span class="p">,</span>
        <span class="n">gateway_port</span><span class="p">:</span>   <span class="mi">2195</span><span class="p">,</span>
        <span class="n">feedback_host</span><span class="p">:</span> <span class="s2">&quot;feedback.push.apple.com&quot;</span><span class="p">,</span>
        <span class="n">feedback_port</span><span class="p">:</span>  <span class="mi">2196</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">sandbox</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">gateway_host</span><span class="p">:</span>  <span class="s2">&quot;gateway.sandbox.push.apple.com&quot;</span><span class="p">,</span>
        <span class="n">gateway_port</span><span class="p">:</span>   <span class="mi">2195</span><span class="p">,</span>
        <span class="n">feedback_host</span><span class="p">:</span> <span class="s2">&quot;feedback.sandbox.push.apple.com&quot;</span><span class="p">,</span>
        <span class="n">feedback_port</span><span class="p">:</span>  <span class="mi">2196</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="providernew">Provider.new</h2>

<p>Supported options are:</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{})</span>
      <span class="n">options</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">[</span> <span class="n">options</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="o">[</span><span class="n">k</span><span class="o">.</span><span class="n">to_sym</span><span class="p">,</span> <span class="n">v</span><span class="o">]</span> <span class="p">}</span> <span class="o">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>cert_bundle_path</code>: If you have both the client certificate and private key in a single
                  PEM bundle, use this as shorthand for setting both <code>certificate_path</code>
                  and <code>private_key_path</code> to the same value.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="n">cert_bundle_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:cert_bundle_path</span><span class="p">)</span>
        <span class="n">options</span><span class="o">[</span><span class="ss">:certificate_path</span><span class="o">]</span> <span class="o">=</span> <span class="n">cert_bundle_path</span>
        <span class="n">options</span><span class="o">[</span><span class="ss">:private_key_path</span><span class="o">]</span> <span class="o">=</span> <span class="n">cert_bundle_path</span>
      <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>certificate_path</code>: The path to your PEM-encoded APNs certificate provided by Apple.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@certificate_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:certificate_path</span><span class="o">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>private_key_path</code>: The path to your PEM-encoded private key associated w/ your APNs cert.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@private_key_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:private_key_path</span><span class="o">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>private_key_pass</code>: The password to your private key if it is encrypted.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@private_key_pass</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:private_key_pass</span><span class="o">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>environment: Shorthand for gateway and feedback values.  You can specify <code>standbox</code> or
           <code>production</code> and the standard Apple service configuration will be filled in.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:environment</span><span class="p">)</span>
        <span class="k">raise</span> <span class="s2">&quot;Unknown APNs environment &#39;</span><span class="si">#{</span><span class="n">environment</span><span class="si">}</span><span class="s2">&#39;!&quot;</span> <span class="k">unless</span> <span class="no">STANDARD_ENVIRONMENTS</span><span class="o">[</span><span class="n">environment</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span>

        <span class="n">options</span><span class="o">.</span><span class="n">merge!</span> <span class="no">STANDARD_ENVIRONMENTS</span><span class="o">[</span><span class="n">environment</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span>
      <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If you do not specify endpoint configuration or environment, the provider defaults to the
<code>production</code> APNs environment.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span> <span class="o">&amp;</span> <span class="o">[</span><span class="ss">:gateway_host</span><span class="p">,</span> <span class="ss">:gateway_port</span><span class="p">,</span> <span class="ss">:feedback_host</span><span class="p">,</span> <span class="ss">:feedback_port</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">options</span><span class="o">.</span><span class="n">merge!</span> <span class="no">STANDARD_ENVIRONMENTS</span><span class="o">[</span><span class="ss">:production</span><span class="o">]</span>
      <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>gateway_host</code>:  Hostname to use for contacting the gateway service.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@gateway_host</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:gateway_host</span><span class="o">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>gateway_port</code>:  Port of the gateway service.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@gateway_port</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:gateway_port</span><span class="o">].</span><span class="n">to_i</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>feedback_host</code>: Hostname to user for contacting the feedback service.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@feedback_host</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:feedback_host</span><span class="o">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>feedback_port</code>: Port of the feedback service.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@feedback_port</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:feedback_port</span><span class="o">].</span><span class="n">to_i</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>name</code>: An identifier for this provider; used for debugging and inspection.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@name</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>log_level</code>: How verbose logging should be.  <code>debug</code>, <code>info</code>, <code>warn</code>, or <code>error</code>.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@log_level</span>         <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:log_level</span><span class="o">]</span> <span class="p">?</span> <span class="n">options</span><span class="o">[</span><span class="ss">:log_level</span><span class="o">].</span><span class="n">to_sym</span> <span class="p">:</span> <span class="ss">:warn</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>log_output_io</code>: An IO object or path that the logger should write to.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@log_output_target</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:log_output_target</span><span class="o">]</span> <span class="o">||</span> <span class="vg">$stdout</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>delay_for_errors</code>: Due to the asychronous nature of APNs protocol, we must wait for a
                  short while for an error response if we want to be able to continue
                  sending large batches of notifications.  This determines how long in
                  seconds that we should wait for an error.  The longer you wait, you
                  are less likely to skip good notifications.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@delay_for_errors</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:delay_for_errors</span><span class="o">]</span> <span class="o">||</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>error_skip_delay</code>: When we encounter an APNs error for a given notification, how long
                  should we delay before resuming the batch after that bad one?</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@error_skip_delay</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:error_skip_delay</span><span class="o">]</span> <span class="o">||</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>retry_backoff</code>: An array of numeric values indicating the # of retries and the delay
               between each.  This backoff strategy applies to all non-APNs errors.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="vi">@retry_backoff</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:retry_backoff</span><span class="o">]</span> <span class="o">||</span> <span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">75</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="o">]</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="public-properties">Public Properties</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Identification and security</p></div></div><div class="code"><div class="wrapper">    <span class="kp">attr_reader</span> <span class="ss">:certificate_path</span>
    <span class="kp">attr_reader</span> <span class="ss">:private_key_path</span>
    <span class="kp">attr_reader</span> <span class="ss">:private_key_pass</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Endpoint configuration</p></div></div><div class="code"><div class="wrapper">    <span class="kp">attr_reader</span> <span class="ss">:gateway_host</span>
    <span class="kp">attr_reader</span> <span class="ss">:gateway_port</span>
    <span class="kp">attr_reader</span> <span class="ss">:feedback_host</span>
    <span class="kp">attr_reader</span> <span class="ss">:feedback_port</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Misc configuration</p></div></div><div class="code"><div class="wrapper">    <span class="kp">attr_reader</span> <span class="ss">:name</span>
    <span class="kp">attr_reader</span> <span class="ss">:log_level</span>
    <span class="kp">attr_reader</span> <span class="ss">:log_output_target</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error handling</p></div></div><div class="code"><div class="wrapper">    <span class="kp">attr_reader</span> <span class="ss">:delay_for_errors</span>
    <span class="kp">attr_reader</span> <span class="ss">:error_skip_delay</span>
    <span class="kp">attr_reader</span> <span class="ss">:retry_backoff</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Each provider has its own logger.</p>

<p>You're welcome to set your own custom logger (such as a
<a href="http://log4r.rubyforge.org/rdoc/Log4r/Logger.html"><code>Log4r::Logger</code></a>).  It must respond to
<code>debug</code>, <code>info</code>, <code>warn</code>, and <code>error</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="kp">attr_writer</span> <span class="ss">:logger</span>
    <span class="k">def</span> <span class="nf">logger</span>
      <span class="vi">@logger</span> <span class="o">||=</span> <span class="k">begin</span>
        <span class="nb">require</span> <span class="s2">&quot;logger&quot;</span>

        <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">log_output_target</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">logger</span><span class="o">|</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">Severity</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">log_level</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">upcase</span><span class="p">)</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">severity</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">progname</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">] </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">) </span><span class="si">#{</span><span class="n">severity</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="notifications">Notifications</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Send a notification payload to one or more devices.</p>

<p>You can either pass an options hash, or an explicit <a href="payload.html"><code>Payload</code></a> object.</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">device_or_devices</span><span class="p">,</span> <span class="n">payload_or_options</span><span class="p">)</span>
      <span class="n">payload</span> <span class="o">=</span> <span class="n">payload_or_options</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="p">?</span> <span class="no">Payload</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">payload_or_options</span><span class="p">)</span> <span class="p">:</span> <span class="n">payload_or_options</span>

      <span class="n">notifications</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">device_or_devices</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">Notification</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="p">}</span>

      <span class="k">if</span> <span class="vi">@batch</span>
        <span class="vi">@batch</span> <span class="o">+=</span> <span class="n">notifications</span>
      <span class="k">else</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">send_notifications</span><span class="p">(</span><span class="n">notifications</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Collects a batch of notifications from calls to <code>notify</code>, and bulk sends them when the block
returns.</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="vi">@batch</span> <span class="o">=</span> <span class="o">[]</span>

      <span class="n">block</span><span class="o">.</span><span class="n">call</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">send_notifications</span><span class="p">(</span><span class="vi">@batch</span><span class="p">)</span>
      <span class="vi">@batch</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">send_notifications</span><span class="p">(</span><span class="n">notifications</span><span class="p">,</span> <span class="n">attempt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">unless</span> <span class="n">notifications</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;Sending batch of notifications:&quot;</span>
      <span class="n">notifications</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">#{</span><span class="n">n</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">packets</span> <span class="o">=</span> <span class="n">notifications</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_packet</span><span class="p">)</span>
      <span class="n">exception</span><span class="p">,</span> <span class="n">delivery_error</span> <span class="o">=</span> <span class="kp">nil</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">gateway_connection</span><span class="o">.</span><span class="n">with_socket</span> <span class="k">do</span> <span class="o">|</span><span class="n">socket</span><span class="o">|</span>
        <span class="k">begin</span>
          <span class="n">packets</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">packet</span><span class="o">|</span>
            <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;  Sending packet: </span><span class="si">#{</span><span class="n">packet</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
          <span class="k">end</span>
          <span class="n">socket</span><span class="o">.</span><span class="n">flush</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Even if we are in an error state, we frequently will not get low-level errors due to TCP's
asynchronous nature.  Or, confusingly, we might have gotten an error from a previous batch
of notifications.</p></div></div><div class="code"><div class="wrapper">        <span class="k">rescue</span>
          <span class="n">exception</span> <span class="o">=</span> <span class="vg">$!</span>
          <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&quot;Encountered error when sending notifications: </span><span class="si">#{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>So, we check for errors after a slight delay, so that we can continue sending the
the remaining notifications.  No delay if we know there can be no extra work.</p></div></div><div class="code"><div class="wrapper">        <span class="n">read_delay</span> <span class="o">=</span> <span class="n">notifications</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="nb">self</span><span class="o">.</span><span class="n">delay_for_errors</span> <span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>

        <span class="k">begin</span>
          <span class="n">readable</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">[</span><span class="n">socket</span><span class="o">]</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">read_delay</span><span class="p">)</span>
          <span class="n">read_bytes</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">read</span> <span class="k">if</span> <span class="n">readable</span>
        <span class="k">rescue</span>
          <span class="n">exception</span> <span class="o">=</span> <span class="vg">$!</span>
        <span class="k">end</span>

        <span class="k">if</span> <span class="n">read_bytes</span>
          <span class="n">delivery_error</span> <span class="o">=</span> <span class="no">DeliveryError</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">read_bytes</span><span class="p">)</span>
          <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&quot;Received APNs delivery error: </span><span class="si">#{</span><span class="n">delivery_error</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">exception</span> <span class="o">||</span> <span class="n">delivery_error</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Regardless of the kind of error we encountered, we need to reconnect</p></div></div><div class="code"><div class="wrapper">        <span class="nb">self</span><span class="o">.</span><span class="n">gateway_connection</span><span class="o">.</span><span class="n">close!</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If a notification in our current batch failed, let's try to continue by skipping it</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="n">delivery_error</span> <span class="o">&amp;&amp;</span> <span class="n">failed_index</span> <span class="o">=</span> <span class="n">notifications</span><span class="o">.</span><span class="n">find_index</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">delivery_error</span><span class="o">.</span><span class="n">identifier</span> <span class="p">}</span>
          <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&quot;Skipping failed notification due to error &#39;</span><span class="si">#{</span><span class="n">delivery_error</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">#{</span><span class="n">notifications</span><span class="o">[</span><span class="n">failed_index</span><span class="o">].</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This restarts retry attempts since it's effectively a new batch</p></div></div><div class="code"><div class="wrapper">          <span class="nb">sleep</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">error_skip_delay</span><span class="p">)</span>
          <span class="nb">self</span><span class="o">.</span><span class="n">send_notifications</span> <span class="nb">Array</span><span class="p">(</span><span class="n">notifications</span><span class="o">[</span><span class="p">(</span><span class="n">failed_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise, standard retry logic</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span>
          <span class="k">return</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">retry_backoff</span><span class="o">[</span><span class="n">attempt</span><span class="o">]</span>
          <span class="nb">sleep</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">retry_backoff</span><span class="o">[</span><span class="n">attempt</span><span class="o">]</span><span class="p">)</span>

          <span class="nb">self</span><span class="o">.</span><span class="n">send_notifications</span><span class="p">(</span><span class="n">notifications</span><span class="p">,</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="connection-management">Connection Management</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">gateway_connection</span>
      <span class="vi">@gateway_connection</span> <span class="o">||=</span> <span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">gateway_host</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">gateway_port</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">ssl_certificate</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">ssl_private_key</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">logger</span>
      <span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">feedback_connection</span>
      <span class="vi">@gateway_connection</span> <span class="o">||=</span> <span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">feedback_host</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">feedback_port</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">ssl_certificate</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">ssl_private_key</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">logger</span>
      <span class="p">)</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The SSL client certificate that this connection will use.</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">ssl_certificate</span>
      <span class="vi">@ssl_certificate</span> <span class="o">||=</span> <span class="k">begin</span>
        <span class="nb">require</span> <span class="s2">&quot;openssl&quot;</span>

        <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;Reading client certificate from </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">certificate_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Certificate</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">certificate_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The private key associated with your client certificate.</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">ssl_private_key</span>
      <span class="vi">@ssl_private_key</span> <span class="o">||=</span> <span class="k">begin</span>
        <span class="nb">require</span> <span class="s2">&quot;openssl&quot;</span>

        <span class="k">begin</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>By passing an empty string, we force OpenSSL to <em>not</em> prompt you for a password if you
forget it.  We don't want stdin breaking your app's initialization process!</p></div></div><div class="code"><div class="wrapper">          <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;Reading private key from </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">private_key_path</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">private_key_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">private_key_pass</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>OpenSSL doesn't give very useful errors</p></div></div><div class="code"><div class="wrapper">        <span class="k">rescue</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSAError</span> <span class="o">=&gt;</span> <span class="n">err</span>
          <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;Failed to read private key from </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">private_key_path</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">raise</span> <span class="s2">&quot;Did you forget or set the wrong private_key_pass?  OpenSSL says: </span><span class="si">#{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">inspect</span>
      <span class="s2">&quot;#&lt;</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
    <span class="k">end</span>

  <span class="k">end</span>

<span class="k">end</span></div></div></div></div></body></html>