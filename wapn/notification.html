<!DOCTYPE html><html lang="en"><head><title>wapn/notification</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="wapn/notification"><meta name="groc-project-path" content="lib/wapn/notification.rb"><meta name="groc-github-url" content="https://github.com/wavii/wapn"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/wavii/wapn/blob/master/lib/wapn/notification.rb">lib/wapn/notification.rb</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="k">module</span> <span class="nn">WAPN</span>
  <span class="k">class</span> <span class="nc">Notification</span>

    <span class="kp">attr_reader</span> <span class="ss">:identifier</span>
    <span class="kp">attr_reader</span> <span class="ss">:device_token</span>
    <span class="kp">attr_reader</span> <span class="ss">:payload</span>
    <span class="kp">attr_reader</span> <span class="ss">:expiration_time</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">device_token</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">expiration_time</span><span class="o">=</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>An integer >= 0 &amp;&amp; &lt;= 2^64 - 1.  E.g. 64-bit unsigned integer.</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@identifier</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">next_identifier</span>

      <span class="vi">@device_token</span>    <span class="o">=</span> <span class="n">device_token</span>
      <span class="vi">@payload</span>         <span class="o">=</span> <span class="n">payload</span>
      <span class="vi">@expiration_time</span> <span class="o">=</span> <span class="n">expiration_time</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The notification in binary form</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">to_packet</span>
      <span class="n">token_length</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">device_token</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># The binary length</span>
      <span class="n">payload</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">apns_json</span>

      <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">expiration_time</span><span class="o">.</span><span class="n">to_i</span><span class="p">,</span> <span class="n">token_length</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">device_token</span><span class="p">,</span> <span class="n">payload</span><span class="o">.</span><span class="n">bytesize</span><span class="p">,</span> <span class="n">payload</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;cNNnH*na*&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Each notification gets a unique identifier so that we can associate errors with them.</p>

<p>This is an incrementing 64-bit integer; so you have to send 2^64 notifications before
identifiers wrap;  If you're running into problems due to repeated identifiers, you've
probably just DoSed the APN service; congratulations!</p></div></div><div class="code"><div class="wrapper">      <span class="k">def</span> <span class="nf">next_identifier</span>
        <span class="vi">@notification_count</span> <span class="o">||=</span> <span class="mi">0</span>
        <span class="vi">@notification_count</span>  <span class="o">+=</span> <span class="mi">1</span>

        <span class="vi">@notification_count</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span>
      <span class="k">end</span>

    <span class="k">end</span>

  <span class="k">end</span>
<span class="k">end</span></div></div></div></div></body></html>